generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  password      String?
  image         String?
  accounts      Account[]
  sessions      Session[]
  videos        Video[]
  projects      Project[]
  smartClipperProjects SmartClipperProject[]
  segmentFeedback      SegmentFeedback[]
  scriptProjects       ScriptProject[]
  conversationProjects ConversationProject[]
  videoGenerationProjects VideoGenerationProject[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Video {
  id             String    @id @default(cuid())
  userId         String    @map("user_id")
  originalName   String    @map("original_name")
  filePath       String    @map("file_path")
  thumbnailPath  String?   @map("thumbnail_path")
  subtitledVideoUrl String? @map("subtitled_video_url")
  subtitleConfig Json?     @map("subtitle_config")
  duration       Float?
  size           Int?
  mimeType       String    @map("mime_type")
  status         String    @default("uploaded")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects  Project[]
  subtitles Subtitle[]
  smartClipperProjects SmartClipperProject[]

  @@map("videos")
}

model Project {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  videoId    String?  @map("video_id")
  name       String
  type       String
  config     Json?
  outputPath String?  @map("output_path")
  status     String   @default("pending")
  progress   Int      @default(0)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  video Video? @relation(fields: [videoId], references: [id], onDelete: SetNull)

  @@map("projects")
}

model Subtitle {
  id         String  @id @default(cuid())
  videoId    String  @map("video_id")
  text       String
  startTime  Float   @map("start_time")
  endTime    Float   @map("end_time")
  confidence Float?
  speaker    String?
  createdAt  DateTime @default(now()) @map("created_at")

  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@map("subtitles")
}

model SmartClipperProject {
  id                    String    @id @default(cuid())
  userId                String    @map("user_id")
  videoId               String    @map("video_id")
  contentType           String    @map("content_type")
  status                String    @default("analyzing")
  config                Json
  analysisResults       Json?     @map("analysis_results")
  processingStage       String?   @default("preprocessing") @map("processing_stage")
  geminiFlashResults    Json?     @map("gemini_flash_results")
  geminiProResults      Json?     @map("gemini_pro_results")
  embeddingScores       Json?     @map("embedding_scores")
  scoringResults        Json?     @map("scoring_results")
  totalSegmentsFound    Int?      @default(0) @map("total_segments_found")
  estimatedCost         Decimal?  @map("estimated_cost") @db.Decimal(10,4)
  actualCost            Decimal?  @map("actual_cost") @db.Decimal(10,4)
  errorMessage          String?   @map("error_message")
  lastFeedbackProcessed DateTime? @map("last_feedback_processed")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  video              Video              @relation(fields: [videoId], references: [id], onDelete: Cascade)
  highlightSegments  HighlightSegment[]
  geminiApiUsage     GeminiApiUsage[]

  @@index([userId])
  @@index([videoId])
  @@index([status])
  @@map("smart_clipper_projects")
}

model HighlightSegment {
  id                   String    @id @default(cuid())
  projectId            String    @map("project_id")
  startTime            Float     @map("start_time")
  endTime              Float     @map("end_time")
  duration             Float
  flashScore           Int?      @map("flash_score")
  proScore             Int       @map("pro_score")
  embeddingScore       Float?    @map("embedding_score")
  finalScore           Int       @map("final_score")
  confidenceLevel      Float     @map("confidence_level")
  highlightType        String?   @map("highlight_type")
  reasoning            String
  geminiClassification String?   @map("gemini_classification")
  contentTags          String[]  @map("content_tags")
  audioEnergyAvg       Float?    @map("audio_energy_avg")
  silenceRatio         Float?    @map("silence_ratio")
  sceneChanges         Int?      @map("scene_changes")
  status               String    @default("pending")
  userApproval         String?   @map("user_approval")
  customStartTime      Float?    @map("custom_start_time")
  customEndTime        Float?    @map("custom_end_time")
  outputPath           String?   @map("output_path")
  s3Url                String?   @map("s3_url")
  generatedAt          DateTime? @map("generated_at")
  errorMessage         String?   @map("error_message")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  project         SmartClipperProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  segmentFeedback SegmentFeedback[]

  @@index([projectId])
  @@index([finalScore])
  @@index([status])
  @@map("highlight_segments")
}

model ContentTypeConfig {
  id                        String   @id @default(cuid())
  type                      String   @unique
  name                      String
  description               String
  icon                      String?
  audioEnergyWeight         Float    @default(0.5) @map("audio_energy_weight")
  visualMotionWeight        Float    @default(0.5) @map("visual_motion_weight")
  speechPatternWeight       Float    @default(0.5) @map("speech_pattern_weight")
  sceneChangeWeight         Float    @default(0.5) @map("scene_change_weight")
  excitementKeywords        String[] @map("excitement_keywords")
  actionKeywords            String[] @map("action_keywords")
  emotionalKeywords         String[] @map("emotional_keywords")
  technicalKeywords         String[] @map("technical_keywords")
  minClipLength             Int      @default(15) @map("min_clip_length")
  maxClipLength             Int      @default(90) @map("max_clip_length")
  preferredClipLength       Int      @default(45) @map("preferred_clip_length")
  maxSegments               Int      @default(10) @map("max_segments")
  minimumConfidence         Float    @default(0.6) @map("minimum_confidence")
  geminiFlashPromptTemplate String   @map("gemini_flash_prompt_template")
  geminiProPromptTemplate   String   @map("gemini_pro_prompt_template")
  embeddingQueryTemplate    String   @map("embedding_query_template")
  isActive                  Boolean  @default(true) @map("is_active")
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  @@map("content_type_configs")
}

model SegmentFeedback {
  id                      String  @id @default(cuid())
  segmentId               String  @map("segment_id")
  userId                  String  @map("user_id")
  feedbackType            String  @map("feedback_type")
  rating                  Int?
  customStartTime         Float?  @map("custom_start_time")
  customEndTime           Float?  @map("custom_end_time")
  feedbackNotes           String? @map("feedback_notes")
  improvementSuggestions  String? @map("improvement_suggestions")
  createdAt               DateTime @default(now()) @map("created_at")

  segment HighlightSegment @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([segmentId])
  @@index([userId])
  @@map("segment_feedback")
}

model GeminiApiUsage {
  id                   String   @id @default(cuid())
  projectId            String   @map("project_id")
  modelName            String   @map("model_name")
  operationType        String   @map("operation_type")
  inputTokens          Int?     @map("input_tokens")
  outputTokens         Int?     @map("output_tokens")
  videoDurationSeconds Float?   @map("video_duration_seconds")
  costUsd              Decimal? @map("cost_usd") @db.Decimal(10,6)
  responseTimeMs       Int?     @map("response_time_ms")
  success              Boolean  @default(true)
  errorMessage         String?  @map("error_message")
  createdAt            DateTime @default(now()) @map("created_at")

  project SmartClipperProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([modelName])
  @@index([createdAt])
  @@map("gemini_api_usage")
}

model ScriptProject {
  id               String            @id @default(cuid())
  userId           String            @map("user_id")
  title            String
  originalPrompt   String            @map("original_prompt")
  scriptLength     String?           @map("script_length")
  tone             String?           
  status           String            @default("generating")
  estimatedCost    Decimal?          @map("estimated_cost") @db.Decimal(10,4)
  actualCost       Decimal?          @map("actual_cost") @db.Decimal(10,4)
  errorMessage     String?           @map("error_message")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  generatedScripts GeneratedScript[]
  scriptApiUsage   ScriptApiUsage[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("script_projects")
}

model GeneratedScript {
  id                String        @id @default(cuid())
  projectId         String        @map("project_id")
  version           Int           @default(1)
  content           String        @db.Text
  structuredContent Json?         @map("structured_content")
  hook              String?       @db.Text
  keyPoints         String[]      @map("key_points")
  conclusion        String?       @db.Text
  wordCount         Int?          @map("word_count")
  estimatedDuration Int?          @map("estimated_duration")
  confidence        Float?        
  userRating        Int?          @map("user_rating")
  userFeedback      String?       @map("user_feedback")
  isActive          Boolean       @default(true) @map("is_active")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  project           ScriptProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([version])
  @@index([isActive])
  @@map("generated_scripts")
}

model ScriptApiUsage {
  id                   String        @id @default(cuid())
  projectId            String        @map("project_id")
  modelName            String        @map("model_name")
  operationType        String        @map("operation_type")
  inputTokens          Int?          @map("input_tokens")
  outputTokens         Int?          @map("output_tokens")
  promptLength         Int?          @map("prompt_length")
  responseLength       Int?          @map("response_length")
  costUsd              Decimal?      @map("cost_usd") @db.Decimal(10,6)
  responseTimeMs       Int?          @map("response_time_ms")
  success              Boolean       @default(true)
  errorMessage         String?       @map("error_message")
  createdAt            DateTime      @default(now()) @map("created_at")

  project              ScriptProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([modelName])
  @@index([createdAt])
  @@map("script_api_usage")
}

model ConversationProject {
  id               String                 @id @default(cuid())
  userId           String                 @map("user_id")
  title            String
  description      String?
  conversationType String                 @map("conversation_type")
  chatStyle        String                 @default("iphone") @map("chat_style")
  backgroundType   String?                @map("background_type")
  backgroundUrl    String?                @map("background_url")
  videoSettings    Json?                  @map("video_settings")
  audioSettings    Json?                  @map("audio_settings")
  status           String                 @default("draft")
  estimatedCost    Decimal?               @map("estimated_cost") @db.Decimal(10,4)
  actualCost       Decimal?               @map("actual_cost") @db.Decimal(10,4)
  videoOutputPath  String?                @map("video_output_path")
  videoDuration    Float?                 @map("video_duration")
  errorMessage     String?                @map("error_message")
  createdAt        DateTime               @default(now()) @map("created_at")
  updatedAt        DateTime               @updatedAt @map("updated_at")

  user             User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  characters       ConversationCharacter[]
  messages         ConversationMessage[]
  generations      ConversationGeneration[]
  conversationApiUsage ConversationApiUsage[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("conversation_projects")
}

model ConversationCharacter {
  id          String   @id @default(cuid())
  projectId   String   @map("project_id")
  name        String
  displayName String?  @map("display_name")
  avatarUrl   String?  @map("avatar_url")
  voiceId     String?  @map("voice_id")
  voiceName   String?  @map("voice_name")
  voiceConfig Json?    @map("voice_config")
  messageColor String? @map("message_color")
  isUser      Boolean  @default(false) @map("is_user")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  project  ConversationProject  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  messages ConversationMessage[]

  @@index([projectId])
  @@index([sortOrder])
  @@map("conversation_characters")
}

model ConversationMessage {
  id           String   @id @default(cuid())
  projectId    String   @map("project_id")
  characterId  String   @map("character_id")
  content      String   @db.Text
  messageType  String   @default("text") @map("message_type")
  delay        Int      @default(1000)
  duration     Float?
  animationType String? @map("animation_type")
  sortOrder    Int      @map("sort_order")
  isVisible    Boolean  @default(true) @map("is_visible")
  timestamp    DateTime? 
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  project   ConversationProject   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  character ConversationCharacter @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([sortOrder])
  @@index([characterId])
  @@map("conversation_messages")
}

model ConversationGeneration {
  id             String   @id @default(cuid())
  projectId      String   @map("project_id")
  version        Int      @default(1)
  prompt         String   @db.Text
  generatedContent Json   @map("generated_content")
  messageCount   Int      @map("message_count")
  estimatedDuration Float? @map("estimated_duration")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  project ConversationProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([version])
  @@index([isActive])
  @@map("conversation_generations")
}

model ConversationApiUsage {
  id                   String              @id @default(cuid())
  projectId            String              @map("project_id")
  modelName            String              @map("model_name")
  operationType        String              @map("operation_type")
  inputTokens          Int?                @map("input_tokens")
  outputTokens         Int?                @map("output_tokens")
  promptLength         Int?                @map("prompt_length")
  responseLength       Int?                @map("response_length")
  costUsd              Decimal?            @map("cost_usd") @db.Decimal(10,6)
  responseTimeMs       Int?                @map("response_time_ms")
  success              Boolean             @default(true)
  errorMessage         String?             @map("error_message")
  createdAt            DateTime            @default(now()) @map("created_at")

  project              ConversationProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([modelName])
  @@index([createdAt])
  @@map("conversation_api_usage")
}

model Library {
  id                String    @id @default(cuid())
  title             String
  description       String?
  videoUrl          String    @map("video_url")
  thumbnailUrl      String?   @map("thumbnail_url")
  duration          Float?
  fileSize          Int?      @map("file_size")
  mimeType          String?   @map("mime_type")
  category          String?   @default("gameplay")
  tags              String[]  @default([])
  uploadSource      String?   @default("seeded") @map("upload_source")
  metadata          Json?
  status            String    @default("active")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  videoGenerationProjects VideoGenerationProject[]

  @@index([category])
  @@index([status])
  @@index([createdAt])
  @@map("library")
}

model VideoGenerationProject {
  id                  String    @id @default(cuid())
  userId              String    @map("user_id")
  title               String
  originalPrompt      String    @map("original_prompt")
  scriptLength        String?   @map("script_length")
  tone                String?
  
  // Phase 1: Script Generation
  scriptStatus        String    @default("pending") @map("script_status")
  generatedScript     Json?     @map("generated_script")
  scriptProjectId     String?   @map("script_project_id")
  
  // Phase 2: Voice Selection  
  voiceStatus         String    @default("pending") @map("voice_status")
  selectedVoice       String?   @map("selected_voice")
  voiceSpeed          Float?    @default(1.0) @map("voice_speed")
  voicePitch          Float?    @default(0) @map("voice_pitch")
  audioUrl            String?   @map("audio_url")
  audioDuration       Float?    @map("audio_duration")
  
  // Phase 3: Video Selection & Generation
  videoStatus         String    @default("pending") @map("video_status")
  selectedVideoId     String?   @map("selected_video_id")
  finalVideoUrl       String?   @map("final_video_url")
  videoDuration       Float?    @map("video_duration")
  
  // Project metadata
  currentPhase        Int       @default(1) @map("current_phase")
  overallStatus       String    @default("script_generation")
  estimatedCost       Decimal?  @map("estimated_cost") @db.Decimal(10,4)
  actualCost          Decimal?  @map("actual_cost") @db.Decimal(10,4)
  errorMessage        String?   @map("error_message")
  processingLogs      Json?     @map("processing_logs")
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  selectedVideo       Library?  @relation(fields: [selectedVideoId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([overallStatus])
  @@index([currentPhase])
  @@index([createdAt])
  @@map("video_generation_projects")
}
